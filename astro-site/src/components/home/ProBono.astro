---
import { getEntry } from 'astro:content';

const proBonoData = await getEntry('proBono', 'home');

if (!proBonoData || !proBonoData.data) {
  throw new Error("Failed to load pro bono content data.");
}

const { sectionTitle, sectionSubtitle, intro, criteriaTitle, criteria, cta, visualCards } = proBonoData.data;
---

<!-- Pro Bono Section -->
<section id="probono" class="py-20 bg-linear-to-br from-[#f0fdf4] to-[#dcfce7]">
  <div class="container">
    <!-- Section Header -->
    <div class="probono-animate text-center mb-16" data-animate-delay="0">
      <h2 class="font-display text-[clamp(2rem,4vw,3rem)] font-extrabold bg-linear-to-r from-[#047857] via-[#10b981] to-[#c9a961] bg-clip-text text-transparent mb-5 tracking-[-0.02em]">
        {sectionTitle}
      </h2>
      <p class="text-[clamp(1.125rem,2vw,1.25rem)] text-(--gray-600) max-w-[700px] mx-auto leading-relaxed">
        {sectionSubtitle}
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
      <!-- Text Content -->
      <div class="flex flex-col gap-6">
        <!-- Intro -->
        <div class="probono-animate flex gap-4 items-start p-6 bg-white rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.08)]" data-animate-delay="100">
          <i class={`${intro.icon} text-[2rem] text-[#10b981] shrink-0`}></i>
          <p class="m-0 leading-relaxed text-(--gray-700) [&_strong]:font-semibold" set:html={intro.text}></p>
        </div>

        <!-- Criteria Title -->
        <h3 class="probono-animate font-display text-2xl text-(--gray-900) mb-4" data-animate-delay="150">
          {criteriaTitle}
        </h3>

        <!-- Criteria List -->
        <div class="flex flex-col gap-4">
          {criteria.map((item, index) => (
            <div 
              class="probono-animate probono-criteria-item flex gap-3 items-start p-4 bg-white rounded-xl transition-all duration-200 hover:translate-x-2 hover:shadow-[0_4px_12px_rgba(16,185,129,0.15)]"
              data-animate-delay={200 + index * 80}
            >
              <i class={`${item.icon} text-xl text-[#10b981] shrink-0 mt-0.5`}></i>
              <span class="text-(--gray-700) leading-relaxed">{item.text}</span>
            </div>
          ))}
        </div>

        <!-- CTA Box -->
        <div class="probono-animate p-6 bg-linear-to-br from-[#10b981] to-[#059669] rounded-2xl text-white text-center" data-animate-delay="500">
          <p class="m-0 mb-4 leading-relaxed"><strong>{cta.question}</strong></p>
          <p class="m-0 mb-6 leading-relaxed">{cta.description}</p>
          <button 
            class="px-6 py-4 bg-white text-[#10b981] border-none rounded-xl font-semibold text-base cursor-pointer inline-flex items-center gap-2 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-[0_10px_30px_rgba(255,255,255,0.3)] hover:bg-[#f0fdf4]"
            onclick={cta.buttonAction}
          >
            <i class="fas fa-hand-holding-heart"></i>
            {cta.buttonText}
          </button>
        </div>
      </div>

      <!-- Visual Cards -->
      <div class="flex flex-col gap-4">
        {visualCards.map((card, index) => (
          <div 
            class="probono-animate probono-card p-6 bg-white rounded-2xl shadow-(--shadow-premium) transition-all duration-300 hover:-translate-y-1 hover:scale-[1.02] hover:shadow-(--shadow-premium-hover)"
            data-animate-delay={100 + index * 120}
          >
            <i class={`${card.icon} text-[2.5rem] text-[#10b981] mb-3 block`}></i>
            <h4 class="font-display text-xl text-(--gray-900) mb-2">{card.title}</h4>
            <p class="text-(--gray-600) leading-relaxed m-0">{card.text}</p>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  /* Initial state for animated elements - hidden */
  .probono-animate {
    opacity: 0;
    transform: translateY(30px);
    transition: 
      opacity 0.7s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: opacity, transform;
  }

  /* Visible state when in viewport */
  .probono-animate.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Criteria items slide from left */
  .probono-criteria-item {
    transform: translateX(-20px) translateY(20px);
  }

  .probono-criteria-item.visible {
    transform: translateX(0) translateY(0);
  }

  /* Visual cards slide from right on desktop */
  @media (min-width: 1024px) {
    .probono-card {
      transform: translateX(30px) translateY(20px);
    }
    
    .probono-card.visible {
      transform: translateX(0) translateY(0);
    }
  }

  /* Icon subtle animation on card visibility */
  .probono-card.visible i {
    animation: iconPop 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
  }

  @keyframes iconPop {
    0% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Accessibility: respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .probono-animate {
      opacity: 1;
      transform: none;
      transition: none;
    }
    
    .probono-card.visible i {
      animation: none;
    }
  }
</style>

<script>
  // Pro Bono modal function
  (window as any).openProBonoModal = function() {
    const modal = document.getElementById('consultaModal');
    const proBonoNotice = modal?.querySelector('[data-notice="probono"]');
    if (proBonoNotice) {
      (proBonoNotice as HTMLElement).hidden = false;
    }
    if (typeof (window as any).openModal === 'function') {
      (window as any).openModal();
    }
  };

  // Scroll-triggered animations with IntersectionObserver
  function initProBonoAnimations() {
    const animatedElements = document.querySelectorAll('.probono-animate');
    
    if (!animatedElements.length) return;

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    if (prefersReducedMotion) {
      // Show all elements immediately if user prefers reduced motion
      animatedElements.forEach(el => el.classList.add('visible'));
      return;
    }

    const observerOptions: IntersectionObserverInit = {
      root: null, // viewport
      rootMargin: '0px 0px -50px 0px', // trigger slightly before element enters viewport
      threshold: 0.1 // 10% visibility triggers animation
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const element = entry.target as HTMLElement;
          const delay = parseInt(element.dataset.animateDelay || '0', 10);
          
          // Apply staggered delay for elegant cascade effect
          setTimeout(() => {
            element.classList.add('visible');
          }, delay);
          
          // Stop observing once animated
          observer.unobserve(element);
        }
      });
    }, observerOptions);

    // Observe all animated elements
    animatedElements.forEach(el => observer.observe(el));
  }

  // Initialize on DOM ready and on Astro page transitions
  document.addEventListener('DOMContentLoaded', initProBonoAnimations);
  document.addEventListener('astro:page-load', initProBonoAnimations);
</script>
