---
import { getEntry } from 'astro:content';

const statsData = await getEntry('stats', 'home');
const { stats } = statsData.data;
---

<section id="stats" class="relative py-20 bg-gradient-to-b from-white via-[#f8fafc] to-[#eff6ff] overflow-hidden">
  <!-- Decorative background elements -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute top-0 right-0 w-[400px] h-[400px] rounded-full blur-[120px] opacity-[0.07] bg-[radial-gradient(circle,var(--blue-primary)_0%,transparent_70%)]"></div>
    <div class="absolute bottom-0 left-0 w-[300px] h-[300px] rounded-full blur-[100px] opacity-[0.05] bg-[radial-gradient(circle,var(--gold)_0%,transparent_70%)]"></div>
  </div>
  <div class="container relative z-10">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
      {stats.map((stat, index) => (
        <div 
          class="stat-item flex items-center gap-5 p-8 bg-[var(--gray-50)] rounded-2xl transition-all duration-200 shadow-[var(--shadow-premium)] hover:-translate-y-1 hover:scale-[1.02] hover:shadow-[var(--shadow-premium-hover)]"
          style={`transition-delay: ${index * 100}ms`}
        >
          <!-- Icon -->
          <div class="w-[72px] h-[72px] flex items-center justify-center bg-gradient-to-br from-[var(--blue-primary)] to-[var(--blue-dark)] rounded-[14px] flex-shrink-0">
            <i class={`${stat.icon} text-[2rem] text-white`}></i>
          </div>
          
          <!-- Content -->
          <div class="flex-1">
            <div 
              class="stat-number text-[3rem] font-extrabold text-[var(--blue-primary)] font-[var(--font-display)] leading-none after:content-['+'] after:text-[var(--gold)]"
              data-target={stat.target}
            >
              0
            </div>
            <div class="text-[var(--gray-600)] text-[0.9375rem] font-medium mt-2">
              {stat.label}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  // Counter animation with IntersectionObserver
  const animateCounter = (element: HTMLElement, target: number) => {
    const duration = 2000;
    const startTime = performance.now();
    
    const updateCounter = (currentTime: number) => {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing function (ease-out-expo)
      const easeOutExpo = 1 - Math.pow(2, -10 * progress);
      const current = Math.round(target * easeOutExpo);
      
      element.textContent = current.toString();
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      } else {
        element.textContent = target.toString();
      }
    };
    
    requestAnimationFrame(updateCounter);
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const statItem = entry.target as HTMLElement;
        statItem.classList.add('visible');
        
        const numberEl = statItem.querySelector('.stat-number') as HTMLElement;
        if (numberEl && numberEl.dataset.target) {
          const target = parseInt(numberEl.dataset.target, 10);
          animateCounter(numberEl, target);
        }
        
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.3 });

  document.querySelectorAll('.stat-item').forEach(el => observer.observe(el));
</script>

<style>
  .stat-item {
    opacity: 0;
    transform: translateY(30px);
  }
  
  .stat-item.visible {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), 
                transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }
</style>
